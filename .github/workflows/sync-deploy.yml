name: Sync Deploy Branch

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  verify-main:
    name: Verify main branch
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      ref: main

  sync-to-deploy:
    name: Sync to deploy branch
    needs: verify-main
    if: needs.verify-main.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: deploy
          fetch-depth: 0

      - name: Fast-forward merge main to deploy
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git merge --ff-only origin/main
          git push origin deploy
          echo "âœ… Successfully synced deploy with main"

  create_PR_on_failure:
    name: Create PR on failure
    needs: verify-main
    if: needs.verify-main.result != 'success' && always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --base deploy \
            --head main \
            --title "sync: main to deploy (CI failed)" \
            --body "Automated sync from main to deploy that requires manual review due to CI failures." \
            --reviewer kuznetsss
